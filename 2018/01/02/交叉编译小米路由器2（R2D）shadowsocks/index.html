<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> 交叉编译小米路由器2（R2D）shadowsocks · yxleung</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="交叉编译小米路由器2（R2D）shadowsocks - yxleung"><meta name="keywords"><meta name="author" content="yxleung"><link rel="short icon" href="/"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yxleung.github.io/atom.xml" title="yxleung"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/categories/technology/" target="_self" data-hover="技术" class="nav-list-link">技术</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">交叉编译小米路由器2（R2D）shadowsocks</h1><div class="post-info">2018-01-02<p class="visit"><i data-hk-page="current">-</i><span>次访问</span></p></div><div class="post-content"><h1 id="交叉编译小米路由器2（R2D）shadowsocks"><a href="#交叉编译小米路由器2（R2D）shadowsocks" class="headerlink" title="交叉编译小米路由器2（R2D）shadowsocks"></a>交叉编译小米路由器2（R2D）shadowsocks</h1><h2 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h2><blockquote>
<p>我是使用 <a href="https://shadowsocks.la/" target="_blank" rel="noopener">https://shadowsocks.la/</a> 提供的shadowsocks服务，由于最近服务商把shadowsocks加密方式换成了google的[chacha20-ietf-poly1305]，但是小米路由器（R2D）内置的ss-redir版本旧不支持。问题就来了，我一直在小米路由器做的透明代理（简单来说既是连接到这个路由的所有请求都自动走shadowsocks服务）就失效了;所以我需要更新R2D的ss-redir以便支持[chacha20-ietf-poly1305]加密;google后没有找到现成的，相关的文章也少，最后只能自己交叉编译一个，同时把编译过程记录下来，方便大家使用;</p>
</blockquote>
<h2 id="小白党，直接使用我编译："><a href="#小白党，直接使用我编译：" class="headerlink" title="小白党，直接使用我编译："></a>小白党，直接使用我编译：</h2><blockquote>
<p>最新版本openwrt-shadowsock下载链接<br><a href="https://github.com/yxleung/blog/raw/master/source/download/ss.zip" target="_blank" rel="noopener">https://github.com/yxleung/blog/raw/master/source/download/ss.zip</a></p>
</blockquote>
<h2 id="折腾党，我们手把手重新编译一次："><a href="#折腾党，我们手把手重新编译一次：" class="headerlink" title="折腾党，我们手把手重新编译一次："></a>折腾党，我们手把手重新编译一次：</h2><blockquote>
<p>编译清单<br>项目地址：<a href="https://github.com/shadowsocks/shadowsocks-libev" target="_blank" rel="noopener">https://github.com/shadowsocks/shadowsocks-libev</a><br>编译环境：ubuntu<br>小米路由器SDK：<a href="http://bigota.miwifi.com/xiaoqiang/sdk/tools/package/sdk_package.zip" target="_blank" rel="noopener">http://bigota.miwifi.com/xiaoqiang/sdk/tools/package/sdk_package.zip</a><br>编译工具：make git autoconf libtool<br>编译核心依赖：TLS pcre libsodium libev c-ares</p>
</blockquote>
<p>下面的操作都在自己的home目录进行，我是临时用docker构建了个ubuntu编译的，所以都在/root目录下<br>1、下载小米路由器SDK<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget http://bigota.miwifi.com/xiaoqiang/sdk/tools/package/sdk_package.zip</div><div class="line">unzip sdk_package.zip</div></pre></td></tr></table></figure></p>
<p>2、设置环境变量<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">export PATH=$PATH:/root/miwifi/sdk_package/toolchain/bin</div><div class="line">export CC=arm-xiaomi-linux-uclibcgnueabi-gcc</div><div class="line">export CXX=arm-xiaomi-linux-uclibcgnueabi-g++`</div><div class="line"><span class="meta">#</span>核心依赖包编译后放在这里</div><div class="line">mkdir /root/miwifi/ss_lib</div><div class="line">export SS_LIB=/root/miwifi/ss_lib</div></pre></td></tr></table></figure></p>
<p>3、安装基础依赖包<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt install -y make git autoconf libtool</div></pre></td></tr></table></figure></p>
<p>4、下载编译安装核心依赖包</p>
<p>编译mbedtls<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cd /root/miwifi/repo</div><div class="line">wget --no-check-certificate https://tls.mbed.org/download/mbedtls-2.6.0-gpl.tgz</div><div class="line">tar -xzvf mbedtls-2.6.0-gpl.tgz</div><div class="line">cd mbedtls-2.6.0</div><div class="line">make -j$(nproc) DESTDIR=$SS_LIB CC=arm-xiaomi-linux-uclibcgnueabi-gcc AR=arm-xiaomi-linux-uclibcgnueabi-ar LD=arm-xiaomi-linux-uclibcgnueabi-ld install</div></pre></td></tr></table></figure></p>
<p>编译pcre<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cd /root/miwifi/repo</div><div class="line">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.41.tar.gz</div><div class="line">tar -xzvf pcre-8.41.tar.gz</div><div class="line">cd pcre-8.41</div><div class="line">./configure --host=arm-xiaomi-linux-uclibcgnueabi --prefix=$SS_LIB --disable-shared --enable-utf8 --enable-unicode-properties</div><div class="line">make -j$(nproc) install</div></pre></td></tr></table></figure></p>
<p>编译libsodium<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cd /root/miwifi/repo</div><div class="line">wget --no-check-certificate https://download.libsodium.org/libsodium/releases/libsodium-1.0.13.tar.gz</div><div class="line">tar -xzvf libsodium-1.0.13.tar.gz</div><div class="line">cd libsodium-1.0.13</div><div class="line">./configure --host=arm-xiaomi-linux-uclibcgnueabi --prefix=$SS_LIB --disable-ssp --disable-shared</div><div class="line">make -j$(nproc) install</div></pre></td></tr></table></figure></p>
<p>编译libev<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cd /root/miwifi/repo</div><div class="line">wget http://dist.schmorp.de/libev/libev-4.24.tar.gz</div><div class="line">tar -xzvf libev-4.24.tar.gz</div><div class="line">cd libev-4.24</div><div class="line">./configure --host=arm-xiaomi-linux-uclibcgnueabi --prefix=$SS_LIB --disable-shared</div><div class="line">make -j$(nproc) install</div></pre></td></tr></table></figure></p>
<p>编译c-ares<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cd /root/miwifi/repo</div><div class="line">wget --no-check-certificate https://c-ares.haxx.se/download/c-ares-1.13.0.tar.gz</div><div class="line">tar -xzvf c-ares-1.13.0.tar.gz</div><div class="line">cd c-ares-1.13.0</div><div class="line">./configure LDFLAGS=-static  --host=arm-xiaomi-linux-uclibcgnueabi --prefix=$SS_LIB</div></pre></td></tr></table></figure></p>
<p>5、正式编译shadowsocks-libev<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mkdir /root/miwifi/ss</div><div class="line">cd /root/miwifi/repo</div><div class="line">git clone https://github.com/shadowsocks/shadowsocks-libev</div><div class="line">cd shadowsocks-libev</div><div class="line">git submodule init</div><div class="line">git submodule update</div><div class="line">./autogen.sh</div><div class="line">./configure LIBS="-lpthread -lm" LDFLAGS="-Wl,-static -static -static-libgcc -L$SS_LIB/lib" CFLAGS="-I$SS_LIB/include" --host=arm-xiaomi-linux-uclibcgnueabi --prefix=/root/miwifi/ss --disable-ssp --disable-documentation --with-mbedtls=$SS_LIB --with-pcre=$SS_LIB --with-sodium=$SS_LIB</div><div class="line">make -j$(nproc) install</div></pre></td></tr></table></figure></p>
<p>编译完成就可以看到/root/miwifi/ss目录下有编译好的文件，copy到小米路由器上跑就好了;</p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/technology/">technology</a><span class="category-list-count">4</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/gnuroot-debian/" style="font-size: 10px;">gnuroot debian</a> <a href="/tags/shadowsocks-R2D-交叉编译-小米路由器/" style="font-size: 10px;">shadowsocks R2D 交叉编译 小米路由器</a> <a href="/tags/tenserflow/" style="font-size: 10px;">tenserflow</a> <a href="/tags/特征工程-信息熵-香农熵-entropy/" style="font-size: 10px;">特征工程 信息熵 香农熵 entropy</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/01/02/交叉编译小米路由器2（R2D）shadowsocks/">交叉编译小米路由器2（R2D）shadowsocks</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/entropy-note-01/">entropy-note-01</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/09/GNUroot-android-ssh/">GNUroot debian android ssh设置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/09/tenserflow-note-01/">tenserflow笔记-01</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2017/09/11/entropy-note-01/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2018 <a href="http://yxleung.github.io" target="_blank">yxleung</a></p><p> </p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script></body></html>